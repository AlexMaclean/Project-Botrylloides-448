#!/bin/bash

K_MIN=25
K_MAX=127
K_STEP=2

CONFIG_FILE=kmer.conf
DATA_FILE=data.csv

#-------------------------------------------------------------------------------

# Top level function to run experiment, just loops through k running trials
function run-experiment {
    # Add the header to the output data.csv
    echo "Real/Flye Assembly time,Quorum Error Correcting time,Estimating Genome Size time,Super-Reads time,Mega-Reads time,Consensus Gap Joining time,# contigs,N50,largest contig,total length" > $DATA_FILE

    # For every K we care about run a trial
    for K in $(eval echo "{$K_MIN..$K_MAX..$K_STEP}")
    do
        run-trial "$K"
    done
}

# Given a K value runs a timed version of MaSurCa on it and record stats
function run-trial {
    K=$1
    OUT_PATH="$K-mer-trial"

    printf '\e[1;7m%-6s\e[m\ue0b0\n' " Running the $K-mer Trial "

    # Change the contig file so it has the right K value
    sed -i "s/GRAPH_KMER_SIZE =.*/GRAPH_KMER_SIZE = $K/g" $CONFIG_FILE

    masurca $CONFIG_FILE || exit 1

    mkdir "$OUT_PATH"
    mv assemble.sh "$OUT_PATH"/
    cd "$OUT_PATH" || return

    STATS=$(../../../assemble-with-stats)
    cd ..
    echo "$K,$STATS" >> $DATA_FILE
}

run-experiment
