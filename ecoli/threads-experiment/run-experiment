#!/bin/bash

THREAD_MIN=2
THREAD_MAX=59
THREAD_STEP=3

CONFIG_FILE=threads.conf
DATA_FILE=data.csv

ASSEMBLE=/home/ubuntu/Project-Botrylloides-448/scripts/assemble-with-stats

#-------------------------------------------------------------------------------

# Top level function to run experiment, just loops through k running trials
function run-experiment {
    # Add the header to the output data.csv
    HEADER=$($ASSEMBLE header)
    echo "threads,$HEADER" > $DATA_FILE

    # For every thread count we care about run a trial
    for T in $(eval echo "{$THREAD_MIN..$THREAD_MAX..$THREAD_STEP}")
    do
        run-trial "$T"
    done
}

# Given a threads value runs a timed version of MaSurCa on it and record stats
function run-trial {
    T=$1
    OUT_PATH="$T-threads-trial"

    printf '\e[1;7m%-6s\e[m\ue0b0\n' " Running the $T Thread Trial "

    # Change the contig file so it has the right thread value
    sed -i "s/NUM_THREADS =.*/NUM_THREADS = $T/g" $CONFIG_FILE

    masurca $CONFIG_FILE || exit 1

    mkdir "$OUT_PATH"
    mv assemble.sh "$OUT_PATH"/
    cd "$OUT_PATH" || return

    STATS=$($ASSEMBLE)
    cd ..
    echo "$T,$STATS" >> $DATA_FILE
}

run-experiment
